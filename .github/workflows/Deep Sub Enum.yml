name: Deep Subdomain Enumeration

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain to enumerate'
        required: true
        default: 'example.com'

jobs:
  subdomain-enum:
    runs-on: ubuntu-latest
    container:
      image: friedablessy/subdomain-enum:latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🛠️ Install git
        run: |
          apt-get update
          apt-get install -y git

      - name: ⚡ Cache Go Tools and Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ~/go/bin
          key: ${{ runner.os }}-go-${{ hashFiles('**/*.go') }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: ⚡ Cache Wordlists
        uses: actions/cache@v4
        with:
          path: ./wordlists/
          key: ${{ runner.os }}-wordlists-v1

      - name: 📁 Create Working Directory
        run: |
          mkdir enum && cd enum
          echo "${{ github.event.inputs.domain }}" > domain.txt

      - name: 🔍 IP Space Discovery
        continue-on-error: true
        run: |
          domain=${{ github.event.inputs.domain }}
          asn=$(curl -s "https://api.hackertarget.com/aslookup/?q=$domain" | grep AS | awk '{print $1}')
          whois -h whois.radb.net -i origin $asn | grep -Eo "([0-9.]+){4}/[0-9]+" | sort -u > ip_ranges.txt

      - name: 🔄 PTR Record Enumeration
        continue-on-error: true
        run: |
          mapcidr -cidr ip_ranges.txt -silent > expanded_ips.txt
          dnsx -ptr -resp-only -l expanded_ips.txt -o ptr_records.txt

      - name: 🖼️ Favicon Hashing
        continue-on-error: true
        run: |
          echo "http://${{ github.event.inputs.domain }}" > urls.txt
          python3 ~/FavFreak/favfreak.py -l urls.txt -o favicons.txt

      - name: 🌐 Related Domain Discovery (Manual Placeholder)
        continue-on-error: true
        run: echo "Manual/External discovery suggested" > related_domains.txt

      - name: 🕵️ Passive Subdomain Enumeration
        continue-on-error: true
        run: |
          subfinder -d ${{ github.event.inputs.domain }} -all -o passive.txt

      - name: 🧰 DNS Brute-force
        continue-on-error: true
        run: |
          puredns bruteforce ./wordlists/dns-Jhaddix.txt ${{ github.event.inputs.domain }} -r resolvers.txt -w dns_bf.txt || true

      # - name: 🔁 Permutation Enumeration
      #   run: |
      #     gotator -sub passive.txt -perm ./wordlists/dns-Jhaddix.txt -depth 1 -adv -md > permuted.txt
      #     puredns resolve permuted.txt -r resolvers.txt -w resolved_perms.txt || true

      - name: ✅ DNS Resolution & Merge
        continue-on-error: true
        run: |
          cat passive.txt dns_bf.txt | sort -u > all_resolved.txt

      - name: 🌊 HTTP Probing
        continue-on-error: true
        run: |
          httpx -l all_resolved.txt -o live_subdomains.txt

      - name: 🕸️ Asset Crawling
        continue-on-error: true
        run: |
          katana -list live_subdomains.txt -o urls.txt

      # - name: 🔦 Vulnerability Detection (Nuclei)
      #   continue-on-error: true
      #   run: |
      #     export HOME=${HOME:-/github/home}
      #     export NUCLEI_TEMPLATE_PATH="${HOME}/.local/nuclei-templates"
      #     if [ ! -d "$NUCLEI_TEMPLATE_PATH" ]; then
      #       git clone https://github.com/projectdiscovery/nuclei-templates "$NUCLEI_TEMPLATE_PATH"
      #     fi
      #     nuclei -l urls.txt -t "$NUCLEI_TEMPLATE_PATH" -o nuclei_results.txt

      - name: 🧪 Manual Review (Placeholder)
        continue-on-error: true
        run: echo "Review results manually (nuclei is skipped)" > manual_review.txt

      - name: 📦 Upload Enumeration Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: enum-results
          path: |
            ip_ranges.txt
            ptr_records.txt
            favicons.txt
            passive.txt
            dns_bf.txt
            all_resolved.txt
            live_subdomains.txt
            urls.txt
